var map,marker_group;const log_map=function(o){console.log("[MAP INFO] "+o)},DEFAULT_ZOOM=2,DEFAULT_PRECISION=8,COORD_DIGITS=8,DEFAULT_LAT=20,DEFAULT_LON=0,LS_INACTIVE_SEC=604800,LS_GOOD_SEC=3600,LS_YELLOW_SEC=7200,LS_RED_SEC=86400;var gw_icon,air_icon_ls_green,air_icon_ls_yellow,air_icon_ls_red,air_icon_ls_inactive;function me_map_clear(){marker_group.clearLayers()}function me_map_init(){map=L.map("map").setView([DEFAULT_LAT,DEFAULT_LON],DEFAULT_ZOOM),L.tileLayer("http://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd",maxZoom:19}).addTo(map),marker_group=(new L.featureGroup).addTo(map),gw_icon=L.icon({iconUrl:"css/images/marker-icon-gw.png",shadowUrl:"css/images/marker-shadow.png",iconSize:L.Icon.Default.prototype.options.iconSize,shadowSize:L.Icon.Default.prototype.options.shadowSize,iconAnchor:L.Icon.Default.prototype.options.iconAnchor,popupAnchor:L.Icon.Default.prototype.options.popupAnchor,shadowSize:L.Icon.Default.prototype.options.shadowSize,shadowAnchor:L.Icon.Default.prototype.options.shadowAnchor}),air_icon_ls_green=L.icon({iconUrl:"css/images/marker-icon-air-ls-green.png",shadowUrl:"css/images/marker-shadow.png",iconSize:L.Icon.Default.prototype.options.iconSize,shadowSize:L.Icon.Default.prototype.options.shadowSize,iconAnchor:L.Icon.Default.prototype.options.iconAnchor,popupAnchor:L.Icon.Default.prototype.options.popupAnchor,shadowSize:L.Icon.Default.prototype.options.shadowSize,shadowAnchor:L.Icon.Default.prototype.options.shadowAnchor}),air_icon_ls_yellow=L.icon({iconUrl:"css/images/marker-icon-air-ls-yellow.png",shadowUrl:"css/images/marker-shadow.png",iconSize:L.Icon.Default.prototype.options.iconSize,shadowSize:L.Icon.Default.prototype.options.shadowSize,iconAnchor:L.Icon.Default.prototype.options.iconAnchor,popupAnchor:L.Icon.Default.prototype.options.popupAnchor,shadowSize:L.Icon.Default.prototype.options.shadowSize,shadowAnchor:L.Icon.Default.prototype.options.shadowAnchor}),air_icon_ls_red=L.icon({iconUrl:"css/images/marker-icon-air-ls-red.png",shadowUrl:"css/images/marker-shadow.png",iconSize:L.Icon.Default.prototype.options.iconSize,shadowSize:L.Icon.Default.prototype.options.shadowSize,iconAnchor:L.Icon.Default.prototype.options.iconAnchor,popupAnchor:L.Icon.Default.prototype.options.popupAnchor,shadowSize:L.Icon.Default.prototype.options.shadowSize,shadowAnchor:L.Icon.Default.prototype.options.shadowAnchor}),air_icon_ls_inactive=L.icon({iconUrl:"css/images/marker-icon-air-ls-inactive.png",shadowUrl:"css/images/marker-shadow.png",iconSize:L.Icon.Default.prototype.options.iconSize,shadowSize:L.Icon.Default.prototype.options.shadowSize,iconAnchor:L.Icon.Default.prototype.options.iconAnchor,popupAnchor:L.Icon.Default.prototype.options.popupAnchor,shadowSize:L.Icon.Default.prototype.options.shadowSize,shadowAnchor:L.Icon.Default.prototype.options.shadowAnchor}),map.on("click",onMapClick)}function onMapClick(o){}function getLastSeenSec(o){new Date(o.last_seen);let e=o.last_seen,t=new Date;return Math.floor(t.getTime()/1e3)-e}function getLastSeen(o){let e=getLastSeenSec(o),t="error";if(e<60)t="< 1 minute";else if(e<3600){let o=Math.round(e/60),n=" minute";o>1&&(n+="s"),t=o.toString()+n}else if(e<86400){let o=Math.round(e/3600),n=" hour";o>1&&(n+="s"),t=o.toString()+n}else if(e<2592e3){let o=Math.round(e/86400),n=" day";o>1&&(n+="s"),t=o.toString()+n}else if(e<31104e3){let o=Math.round(e/2592e3),n=" month";o>1&&(n+="s"),t=o.toString()+n}else if(e<=31104e4){let o=Math.round(e/31104e3),n=" year";o>1&&(n+="s"),t=o.toString()+n}else t="never";return{seconds:e,description:t}}function getStateStr(o,e){if(e>LS_INACTIVE_SEC)return"Inactive [last seen]";let t=o.state;if(t)switch(t){case 1:return"Active";default:return"Inactive"}return"Unknown"}function getTypeStr(o){switch(me_lib_type(o)){case ME_TYPE_AIR:return"AIR";case ME_TYPE_GW:return"GW"}return"Unknown"}function getTypeVerStr(o){let e=me_lib_type(o),t=me_lib_type_ver(o);switch(e){case ME_TYPE_AIR:return"AIR_V"+t;case ME_TYPE_GW:return"GW_V"+t}return"Unknown"}function me_map_plot_record(o,e){let t=parseFloat(e.location.lat)||0,n=parseFloat(e.location.lon)||0;var r=L.marker([t,n]).addTo(marker_group);let a=new Date(1e3*e.timestamp),i="";i+=o+" location: "+t.toFixed(COORD_DIGITS)+", "+n.toFixed(COORD_DIGITS)+"<br>",i+="Time: "+a+"<br>",r.bindPopup(i)}function zoomPoints(o){o||(o=.5),map.fitBounds(marker_group.getBounds().pad(o))}function getMarker(o,e,t,n){var r;switch(me_lib_type(o)){case ME_TYPE_AIR:r=n<LS_GOOD_SEC?L.marker([e,t],{icon:air_icon_ls_green}):n<LS_YELLOW_SEC?L.marker([e,t],{icon:air_icon_ls_yellow}):n<LS_INACTIVE_SEC?L.marker([e,t],{icon:air_icon_ls_red}):L.marker([e,t],{icon:air_icon_ls_inactive});break;case ME_TYPE_GW:r=L.marker([e,t],{icon:gw_icon});break;default:r=L.marker([e,t])}return r}function me_map_add(o,e,t){let n=getLastSeen(o);if(!t&&n.seconds>LS_INACTIVE_SEC)return void log_map("filter inactive "+o.station_id+" last seen: "+n.description+" ago");log_map("adding "+o.station_id+" last seen: "+n.description+" ago");let r=e(o.account),a="pages/data/index.html?station="+o.account+me_lib_get_chain_param()+"&days=1",i="pages/stations/"+getTypeVerStr(o.account)+"/index.html",c=parseFloat(o.location.lat)||0,s=parseFloat(o.location.lon)||0;if(0===c||0===s)return void console.log("not adding "+o.account);var p=getMarker(o.account,c,s,n.seconds).addTo(marker_group);let l="";l+="Station ID: <b>"+o.account+"</b> &nbsp;"+getTypeVerStr(o.account)+"<br>",l+="Station name: "+o.station_id+"<br>",l+="Location: "+c.toFixed(COORD_DIGITS)+", "+s.toFixed(COORD_DIGITS)+"<br>",l+="Last seen: "+n.description+" ago<br>",l+="State: "+getStateStr(o,n.seconds)+"<br>",l+='<a href="'+a+'" target="_blank" rel="noopener noreferrer">Charts</a> &nbsp;|&nbsp; ',l+='<a href="'+r+'" target="_blank" rel="noopener noreferrer">Live Stream</a> &nbsp;|&nbsp; ',l+='<a href="'+i+'" target="_blank" rel="noopener noreferrer">Datasheet</a>',p.bindPopup(l)}